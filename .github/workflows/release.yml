name: Build and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Run tests
      run: cargo test --verbose

  build:
    name: Build Release Binaries
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: learning-programming-app-linux-x64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            name: learning-programming-app-windows-x64.exe
          - target: x86_64-apple-darwin
            os: macos-latest
            name: learning-programming-app-macos-x64
          - target: aarch64-apple-darwin
            os: macos-latest
            name: learning-programming-app-macos-arm64
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Build release binary
      run: cargo build --release --target ${{ matrix.target }}
      
    - name: Create binary directory
      run: mkdir -p binaries
      
    - name: Copy binary (Unix)
      if: matrix.os != 'windows-latest'
      run: cp target/${{ matrix.target }}/release/learning-programming-app binaries/${{ matrix.name }}
      
    - name: Copy binary (Windows)
      if: matrix.os == 'windows-latest'
      run: copy target\${{ matrix.target }}\release\learning-programming-app.exe binaries\${{ matrix.name }}
      
    - name: Upload binary artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.name }}
        path: binaries/${{ matrix.name }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Get version from Cargo.toml
      id: version
      run: |
        VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
        echo "version=v$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
    - name: Check if tag exists
      id: tag_check
      run: |
        if git rev-parse "${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Download all artifacts
      if: steps.tag_check.outputs.exists == 'false'
      uses: actions/download-artifact@v3
      with:
        path: artifacts
        
    - name: Create binary README
      if: steps.tag_check.outputs.exists == 'false'
      run: |
        cat > BINARY_README.md << 'EOF'
        # Learning Programming App - Binary Release
        
        ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å­¦ç¿’è€…å‘ã‘ã®ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–å‹è‡ªå‹•å®Ÿè¡ŒCLIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
        
        ## ğŸ“¦ ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«
        
        ã“ã®ãƒªãƒªãƒ¼ã‚¹ã«ã¯ä»¥ä¸‹ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ç”¨ã®ãƒã‚¤ãƒŠãƒªãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š
        
        - **Linux (x64)**: `learning-programming-app-linux-x64`
        - **Windows (x64)**: `learning-programming-app-windows-x64.exe`
        - **macOS (Intel)**: `learning-programming-app-macos-x64`
        - **macOS (Apple Silicon)**: `learning-programming-app-macos-arm64`
        
        ## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ
        
        ### 1. ãƒã‚¤ãƒŠãƒªã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        
        ãŠä½¿ã„ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«å¯¾å¿œã™ã‚‹ãƒã‚¤ãƒŠãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
        
        ### 2. å®Ÿè¡Œæ¨©é™ã®ä»˜ä¸ï¼ˆLinux/macOSï¼‰
        
        ```bash
        # Linux
        chmod +x learning-programming-app-linux-x64
        
        # macOS (Intel)
        chmod +x learning-programming-app-macos-x64
        
        # macOS (Apple Silicon)
        chmod +x learning-programming-app-macos-arm64
        ```
        
        ### 3. åŸºæœ¬çš„ãªä½¿ç”¨æ–¹æ³•
        
        ```bash
        # ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
        ./learning-programming-app-linux-x64 --help
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ã‚’é–‹å§‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ./examplesï¼‰
        ./learning-programming-app-linux-x64 watch
        
        # ç‰¹å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç›£è¦–
        ./learning-programming-app-linux-x64 watch --directory ./my-exercises
        
        # åˆ©ç”¨å¯èƒ½ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        ./learning-programming-app-linux-x64 sections
        
        # å®Ÿè¡Œå±¥æ­´ã‚’è¡¨ç¤º
        ./learning-programming-app-linux-x64 history
        
        # çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
        ./learning-programming-app-linux-x64 stats
        
        # Goå­¦ç¿’å•é¡Œã‚’ç”Ÿæˆ
        ./learning-programming-app-linux-x64 generate-go
        ```
        
        ## ğŸ“‹ å¿…è¦ãªç’°å¢ƒ
        
        ### Python ãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œç”¨
        - **Python**: 3.x ä»¥é™
        - ã‚³ãƒãƒ³ãƒ‰: `python` ã¾ãŸã¯ `python3` ãŒPATHã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
        
        ### Go ãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œç”¨
        - **Go**: 1.18 ä»¥é™
        - ã‚³ãƒãƒ³ãƒ‰: `go` ãŒPATHã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
        
        ## ğŸ”§ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        
        ### ã‚·ã‚¹ãƒ†ãƒ PATHã«è¿½åŠ 
        
        **Linux/macOS:**
        ```bash
        # ãƒã‚¤ãƒŠãƒªã‚’ /usr/local/bin ã«ç§»å‹•
        sudo mv learning-programming-app-linux-x64 /usr/local/bin/learning-programming-app
        
        # ã©ã“ã‹ã‚‰ã§ã‚‚å®Ÿè¡Œå¯èƒ½
        learning-programming-app --help
        ```
        
        **Windows:**
        1. `learning-programming-app-windows-x64.exe` ã‚’é©å½“ãªãƒ•ã‚©ãƒ«ãƒ€ï¼ˆä¾‹ï¼š`C:\tools\`ï¼‰ã«é…ç½®
        2. ãã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚·ã‚¹ãƒ†ãƒ ã®PATHç’°å¢ƒå¤‰æ•°ã«è¿½åŠ 
        3. ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‹ã‚‰ `learning-programming-app-windows-x64.exe` ã§å®Ÿè¡Œ
        
        ## ğŸ“š ä½¿ç”¨ä¾‹
        
        ### åŸºæœ¬çš„ãªå­¦ç¿’ãƒ•ãƒ­ãƒ¼
        
        1. **ç›£è¦–é–‹å§‹**
        ```bash
        ./learning-programming-app-linux-x64 watch
        ```
        
        2. **ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†**
        - `examples/section1-basics/hello_world.py` ã‚’é–‹ã
        - ã‚³ãƒ¼ãƒ‰ã‚’ç·¨é›†ã—ã¦ä¿å­˜
        - è‡ªå‹•çš„ã«å®Ÿè¡ŒçµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹
        
        3. **é€²æ—ç¢ºèª**
        ```bash
        # å®Ÿè¡Œå±¥æ­´ã‚’ç¢ºèª
        ./learning-programming-app-linux-x64 history --limit 5
        
        # çµ±è¨ˆæƒ…å ±ã‚’ç¢ºèª
        ./learning-programming-app-linux-x64 stats
        ```
        
        ### Goå­¦ç¿’å•é¡Œã®ç”Ÿæˆã¨ä½¿ç”¨
        
        1. **å•é¡Œç”Ÿæˆ**
        ```bash
        ./learning-programming-app-linux-x64 generate-go --output ./my-go-learning
        ```
        
        2. **ç”Ÿæˆã•ã‚ŒãŸå•é¡Œã§å­¦ç¿’**
        ```bash
        # ç”Ÿæˆã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç›£è¦–
        ./learning-programming-app-linux-x64 watch --directory ./my-go-learning
        ```
        
        ## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
        
        ### ã‚ˆãã‚ã‚‹å•é¡Œ
        
        **1. "python: command not found"**
        - PythonãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯PATHã«è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“
        - Python 3.x ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€`python` ã¾ãŸã¯ `python3` ã‚³ãƒãƒ³ãƒ‰ãŒä½¿ç”¨å¯èƒ½ã‹ç¢ºèªã—ã¦ãã ã•ã„
        
        **2. "go: command not found"**
        - GoãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯PATHã«è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“
        - Go 1.18ä»¥é™ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€`go` ã‚³ãƒãƒ³ãƒ‰ãŒä½¿ç”¨å¯èƒ½ã‹ç¢ºèªã—ã¦ãã ã•ã„
        
        **3. "permission denied" (Linux/macOS)**
        - ãƒã‚¤ãƒŠãƒªã«å®Ÿè¡Œæ¨©é™ãŒä»˜ä¸ã•ã‚Œã¦ã„ã¾ã›ã‚“
        - `chmod +x <ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«å>` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
        
        **4. macOSã§ "cannot be opened because the developer cannot be verified"**
        - ã‚·ã‚¹ãƒ†ãƒ è¨­å®š > ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ã§è¨±å¯ã™ã‚‹ã‹
        - `xattr -d com.apple.quarantine <ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«å>` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
        
        ## ğŸ“– è©³ç´°ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
        
        ã‚ˆã‚Šè©³ç´°ãªä½¿ç”¨æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®README.mdã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š
        https://github.com/[your-username]/learning-programming-app
        
        ## ğŸ†• ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ–°æ©Ÿèƒ½
        
        - ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè¡Œ
        - Python (.py) ãŠã‚ˆã³ Go (.go) ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µãƒãƒ¼ãƒˆ
        - å®Ÿè¡Œå±¥æ­´ã®æ°¸ç¶šåŒ–ï¼ˆSQLiteï¼‰
        - çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º
        - Goå­¦ç¿’å•é¡Œã®è‡ªå‹•ç”Ÿæˆ
        - ã‚¨ãƒ©ãƒ¼è€æ€§ã®ã‚ã‚‹ç¶™ç¶šå‹•ä½œ
        
        ## ğŸ“ ã‚µãƒãƒ¼ãƒˆ
        
        å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€GitHubã®Issuesãƒšãƒ¼ã‚¸ã§å ±å‘Šã—ã¦ãã ã•ã„ï¼š
        https://github.com/[your-username]/learning-programming-app/issues
        EOF
        
    - name: Create release
      if: steps.tag_check.outputs.exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Release ${{ steps.version.outputs.version }}
        body: |
          ## ğŸš€ Learning Programming App ${{ steps.version.outputs.version }}
          
          ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å­¦ç¿’è€…å‘ã‘ã®ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–å‹è‡ªå‹•å®Ÿè¡ŒCLIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
          
          ### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          
          ãŠä½¿ã„ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«å¯¾å¿œã™ã‚‹ãƒã‚¤ãƒŠãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼š
          
          - **Linux (x64)**: `learning-programming-app-linux-x64`
          - **Windows (x64)**: `learning-programming-app-windows-x64.exe`
          - **macOS (Intel)**: `learning-programming-app-macos-x64`
          - **macOS (Apple Silicon)**: `learning-programming-app-macos-arm64`
          
          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          
          1. ãƒã‚¤ãƒŠãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸ï¼ˆLinux/macOS: `chmod +x <ãƒã‚¤ãƒŠãƒªå>`ï¼‰
          3. `./ãƒã‚¤ãƒŠãƒªå --help` ã§ãƒ˜ãƒ«ãƒ—ã‚’ç¢ºèª
          4. `./ãƒã‚¤ãƒŠãƒªå watch` ã§ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ã‚’é–‹å§‹
          
          ### ğŸ“‹ å¿…è¦ãªç’°å¢ƒ
          
          - **Python**: 3.xï¼ˆPythonãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œç”¨ï¼‰
          - **Go**: 1.18ä»¥é™ï¼ˆGoãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œç”¨ï¼‰
          
          è©³ç´°ãªä½¿ç”¨æ–¹æ³•ã¯ `BINARY_README.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
          
          ### ğŸ†• ä¸»ãªæ©Ÿèƒ½
          
          - ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜æ™‚ã®è‡ªå‹•å®Ÿè¡Œ
          - Python/Goè¨€èªã‚µãƒãƒ¼ãƒˆ
          - å®Ÿè¡Œå±¥æ­´ã®æ°¸ç¶šåŒ–
          - çµ±è¨ˆæƒ…å ±è¡¨ç¤º
          - Goå­¦ç¿’å•é¡Œè‡ªå‹•ç”Ÿæˆ
          - ã‚¨ãƒ©ãƒ¼è€æ€§ã®ã‚ã‚‹ç¶™ç¶šå‹•ä½œ
        files: |
          artifacts/learning-programming-app-linux-x64/learning-programming-app-linux-x64
          artifacts/learning-programming-app-windows-x64.exe/learning-programming-app-windows-x64.exe
          artifacts/learning-programming-app-macos-x64/learning-programming-app-macos-x64
          artifacts/learning-programming-app-macos-arm64/learning-programming-app-macos-arm64
          BINARY_README.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}